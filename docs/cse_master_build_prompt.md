# Exhale Academy CSE Master Build Prompt (Locked Standard)

You are my lead engineer. Build Exhale Academy CSE as a true NBRC-style clinical simulation engine.

## Non-Negotiable Standards
1. Bandersnatch branching (true decision tree)
- Student selections determine the data reveal and next step.
- Do not render literal “If student chose X…” paragraphs.
- Data reveals are generated by rules, not hardcoded dual-outcome blocks.

2. NBRC simulation structure
- Each case is 6-7 steps total.
- Each step is either:
  - IG = “SELECT AS MANY AS INDICATED”
  - DM = “CHOOSE ONLY ONE”
- Do not display or imply IG selection counts in student-facing text (no `MAX N`, no `up to N`, no numeric hints).
- Every step has a clear student-facing prompt.
- Every step ends with STOP/Submit.
- After STOP, render a rule-driven Data Reveal and advance state.

3. Scoring system
- Option scores allowed: `+3`, `+2`, `+1`, `0`, `-1`, `-2`, `-3`.
- IG: sum selected option scores (respect `max_select`).
- DM: selected option score.
- Track running total score in attempt state.
- Tutor mode: per-step score visible.
- Exam mode: score hidden until end.

3b. Exam scoring blueprint
- Full exam blueprint targets 22 scored CSE problems across 8 categories.
- Include 2 pretest scenarios that are separately tagged and excluded from fixed cut-score calculations until committee scoring is applied.
- Scoring weight must preserve IG-heavy contribution (more than half of total available points should come from IG sections).
- Passing standard is versioned by exam form (`minimum_passing_score` per form/version), not a single global constant.
- Operational target guidance for prep analytics: approximately 72% equivalent performance is typically passing, but final pass/fail uses form-specific cut score.

4. Tutor vs Exam mode
- Tutor after STOP: outcome + rationales + step score + running total.
- Exam after STOP: outcome + continue only.
- Exam rationales and scoring are revealed only on final summary.

5. Realistic patient reactions
- Data reveals include clinically meaningful state changes (SpO2, HR, BP, WOB, mental status).
- Consequences should reflect priorities and timing.
- Keep tone challenging but not demoralizing.
- Keep wording new-grad friendly: correct medical terminology, but avoid unnecessary jargon density.
- Use direct, plain instructions and concise prompt wording.
- Match instructor voice: use the same straightforward, conversational wording style used in the source lesson notes.
- This plain-language style rule applies to both CSE and TMC content shown on the website.

5b. Emergency-first interpretation guardrail
- Scenario design must train this sequence:
  1) First interpret: emergency vs non-emergency.
  2) If emergency: immediate stabilizing actions must be prioritized before extended diagnostics.
  3) If non-emergency: focused information gathering should precede definitive decisions.
- Early-step options must include both immediate-action choices and delay traps so prioritization is testable.

5c. IG authoring guardrail (all CSE cases)
- Every IG step must present 15-20 selectable parameters.
- IG selection design must follow this progression:
  1) Visual findings first
  2) Bedside assessments second
  3) Basic lab/imaging tests third
  4) Special tests last (only if specifically indicated)
- Correct/incorrect scoring must be anchored to `public.cse_reference_values` ranges and normals.
- Prioritize clinically relevant and time-appropriate selections; penalize unnecessary, premature, or unsafe selections.
- Do not explicitly ask students "is this an emergency"; scenarios must make urgency inferable from findings.
- IG click behavior contract: selected parameter should reveal its result immediately and be usable for next decisions.

5d. DM authoring guardrail (all CSE cases)
- Every DM step must present 4-5 options.
- DM prompts remain single-select unless explicitly designed otherwise: `CHOOSE ONLY ONE`.
- DM options must include:
  - one best available action for current data state,
  - at least one plausible but suboptimal alternative,
  - at least one clearly unsafe or delay-causing action.
- DM scoring/rationales must be anchored to `public.cse_reference_values` and case context (severity, urgency, trend).
- Build for "best available" selection logic: if ideal care is unavailable in listed options, highest-score option must represent next-best safe decision.
- Do not penalize a clinically reasonable second-best choice as catastrophic unless it is unsafe.
- DM outcomes must model realistic progression after action (improve, partial response, or deterioration) and feed the next IG/DM cycle.

6. Originality policy
- No copied wording/stems/options from third-party prep materials.
- Cases must be original Exhale language inspired by mechanics only.

7. Mobile-first UI
- One step per screen with three persistent windows:
  - Scenario (top, includes instructions)
  - Options (bottom-left)
  - Simulation History (bottom-right)
- Scenario window includes student photo area in upper-right.
- Continue control uses `Go To Next Section` with required confirmation modal.
- Do not render a permanently visible `Patient Vitals` block above answer choices.
- Patient appearance/vitals should be revealed through rule-driven outcomes and step metadata after student selections.
- Opening scenario data can vary by case design:
  - appearance-only opening,
  - vitals-only opening,
  - mixed opening.
- Tutor-mode post-submit outcome text must be visually prominent (`bold`, larger body text).
- Hideable time-remaining control shown in the lower-right area.

8. Reliability
- Supabase Auth + RLS protected.
- Attempt state persists and resumes after refresh.

9. Case categorization standard
- Case selection and lists should be grouped by disease process (`disease_slug`) and track (`disease_track`).
- Do not require numeric display labels in student-facing case titles.
- `case_number` may remain nullable for legacy compatibility but must not drive new case authoring UX.

10. Clinical reference source of truth
- Use `public.cse_reference_values` as the baseline source for normals/ranges during case generation.
- Keep source-tagged inserts (for example: RTZ reference sets) so values are auditable and replaceable.

11. Scoring reference source of truth
- Use `docs/cse_scoring_standard.md` as the canonical CSE exam scoring policy.

12. Disease playbook source of truth
- Use `public.cse_disease_playbooks` for disease-specific authoring guidance across scenario cues, IG priorities, DM best-available patterns, and unsafe-action penalties.
- Case generation should pull disease and track from this table before drafting options/rules. For COPD use `non_critical` or `critical`; other diseases may still use `conservative` or `critical`.

13. Dynamic reveal authoring standard
- Use `cse_steps.metadata` to encode post-selection reveal behavior for each step.
- Recommended metadata keys:
  - `show_appearance_after_submit` (boolean)
  - `appearance_text` (text)
  - `appearance_keys_any` (string array; optional)
  - `show_vitals_after_submit` (boolean)
  - `vitals_keys_any` (string array; optional)
  - `vitals_fields` (string array; for example `["spo2","rr","hr"]`, `["temp_c","spo2"]`, `["bp","hr"]`)
  - `normal_reference` (object keyed by vital, for example `{ "spo2": "95-100%", "rr": "12-20 /min" }`)
  - `extra_reveals` (array of `{ text, keys_any? }`)
- Reveal logic must be option-sensitive where clinically relevant (for example, vitals shown only after the learner selects monitoring-related actions).
- Vitals shown after submit must vary across scenarios/steps; do not reuse the exact same vital set in every opening or follow-up reveal.
- Build normal ranges from `public.cse_reference_values` and attach concise normal-reference context in reveal metadata where helpful.

## Required Data Model
- `cse_cases` with `slug`, `title`, `intro_text`, active flags.
- `cse_steps` with `step_order`, `step_type`, `prompt`, `max_select`.
- Every `cse_steps` row must include Scenario structure fields:
  - `scenario_setting`: physical setting/context (facility/unit/time/environment)
  - `scenario_patient_summary`: age/sex/appearance/presenting condition
  - `scenario_history`: relevant history + brief active illness/event summary
- `cse_options` with `option_key`, `score`, `rationale`.
- `cse_rules` with ordered branching rules, outcome text, vitals delta.
- `cse_attempts` with mode, current step pointer, total score, vitals.
- `cse_attempt_events` with per-step submission history.

## Rule Engine Contract
- Evaluate rules by ascending `rule_priority`.
- First matching rule wins.
- Exactly one `DEFAULT` rule per step is required.
- `next_step_id = null` ends the case.

## Validation Requirements
- Admin debug tooling must verify:
  - case step counts
  - IG step `max_select`
  - IG step option count in range `15-20`
  - DM step option count in range `4-5`
  - option score values are constrained to `-3..+3`
  - exactly one DEFAULT rule per step
  - no forbidden “If student …” phrasing in outcomes

## Active Runbook
Run only:
1. `docs/cse_reset_all_data.sql` (clears current CSE cases/attempt data)
2. `docs/cse_branching_engine_migration.sql`
3. `docs/cse_reference_values_migration.sql`
4. `docs/cse_reference_values_rtz_seed.sql`
5. `docs/cse_disease_knowledge_migration.sql`
6. `docs/cse_copd_track_rename_migration.sql`
7. `docs/cse_disease_playbooks_seed.sql`
8. Case inserts grouped by disease/track categories (for example: COPD-non-critical first set), using non-numeric student-facing titles

Legacy static SQL is archived under:
- `docs/legacy_static_cse/`
